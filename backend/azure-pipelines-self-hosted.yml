# Azure DevOps Pipeline for Railway Deployment
# This version uses self-hosted agents (no parallelism grant needed)
# Use this if you have a self-hosted agent pool set up

trigger:
  branches:
    include:
      - main
      - master
      - develop

# Use self-hosted agent pool (configure in Azure DevOps)
# Replace "Default" with your agent pool name
# IMPORTANT: Only use this if you have a self-hosted agent set up!
pool:
  name: Default  # Change to your agent pool name
  demands: []  # Accept any agent version (remove if you need specific version)
  # Remove vmImage - that's for Microsoft-hosted only

variables:
  RAILWAY_TOKEN: $(RAILWAY_TOKEN) # Set in Azure DevOps Variables
  NODE_VERSION: '18.x'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: $(NODE_VERSION)
    displayName: 'Install Node.js'

  - script: |
      npm install -g @railway/cli
    displayName: 'Install Railway CLI'

  - script: |
      cd backend
      npm ci
      npm run build
    displayName: 'Build TypeScript'

  - script: |
      cd backend
      export RAILWAY_TOKEN=$(RAILWAY_TOKEN)
      railway up --detach
    displayName: 'Deploy to Railway'
    env:
      RAILWAY_TOKEN: $(RAILWAY_TOKEN)
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/develop'))

  - script: |
      echo "Deployment completed successfully"
      echo "Service URL: Check Railway dashboard for your service URL"
    displayName: 'Deployment Summary'
    condition: succeeded()

